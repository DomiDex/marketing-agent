# Architecture Overview

Detailed technical architecture for the Marketing Agent API.

## System Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              CLIENT CHANNELS                                  â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚   â”‚  Telegram   â”‚    â”‚    Web      â”‚    â”‚   Slack     â”‚                     â”‚
â”‚   â”‚    Bot      â”‚    â”‚   (Future)  â”‚    â”‚  (Future)   â”‚                     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚          â”‚                  â”‚                  â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                  â”‚                  â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                HONO API                                       â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                         API ROUTES                                    â”‚  â”‚
â”‚   â”‚                                                                       â”‚  â”‚
â”‚   â”‚  /api/v1/skills      - List, get, detect skills                      â”‚  â”‚
â”‚   â”‚  /api/v1/clients     - CRUD client profiles                          â”‚  â”‚
â”‚   â”‚  /api/v1/runs        - Execute skills, check status                  â”‚  â”‚
â”‚   â”‚  /api/v1/outputs     - List, download generated content              â”‚  â”‚
â”‚   â”‚  /api/v1/feedback    - Submit and retrieve feedback                  â”‚  â”‚
â”‚   â”‚  /api/v1/webhooks/*  - Telegram, Inngest callbacks                   â”‚  â”‚
â”‚   â”‚                                                                       â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚   â”‚    Auth      â”‚  â”‚ Rate Limit   â”‚  â”‚  Validation  â”‚                     â”‚
â”‚   â”‚  Middleware  â”‚  â”‚  Middleware  â”‚  â”‚  (Zod)       â”‚                     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                           â”‚
                    â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       SKILL DETECTOR          â”‚  â”‚              INNGEST                       â”‚
â”‚                               â”‚  â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  1. Direct Command      â”‚  â”‚  â”‚  â”‚         JOB FUNCTIONS               â”‚  â”‚
â”‚  â”‚     /copywriting        â”‚  â”‚  â”‚  â”‚                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚  skill.execute                      â”‚  â”‚
â”‚              â”‚ no match       â”‚  â”‚  â”‚  â”œâ”€ Load skill from S3              â”‚  â”‚
â”‚              â–¼                â”‚  â”‚  â”‚  â”œâ”€ Load client context              â”‚  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚  â”œâ”€ Build prompt                    â”‚  â”‚
â”‚  â”‚  2. Keyword Match       â”‚  â”‚  â”‚  â”‚  â”œâ”€ Execute via Agent SDK           â”‚  â”‚
â”‚  â”‚     triggerKeywords     â”‚  â”‚  â”‚  â”‚  â””â”€ Save output to S3               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚                                     â”‚  â”‚
â”‚              â”‚ low confidence â”‚  â”‚  â”‚  skill.retry                        â”‚  â”‚
â”‚              â–¼                â”‚  â”‚  â”‚  â””â”€ Retry failed executions         â”‚  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”‚                                     â”‚  â”‚
â”‚  â”‚  3. Claude Haiku        â”‚  â”‚  â”‚  â”‚  feedback.process                   â”‚  â”‚
â”‚  â”‚     Disambiguation      â”‚  â”‚  â”‚  â”‚  â””â”€ Aggregate and analyze           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚                                     â”‚  â”‚
â”‚                               â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            AGENT EXECUTOR                                     â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                     Claude Agent SDK                                 â”‚   â”‚
â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â”‚   import { query } from '@anthropic-ai/claude-agent-sdk';           â”‚   â”‚
â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â”‚   const result = await query({                                       â”‚   â”‚
â”‚   â”‚     prompt: skillContent + clientContext + userMessage,              â”‚   â”‚
â”‚   â”‚     model: 'claude-sonnet-4',                                        â”‚   â”‚
â”‚   â”‚     tools: ['Read', 'Write', 'WebSearch', 'WebFetch'],              â”‚   â”‚
â”‚   â”‚   });                                                                â”‚   â”‚
â”‚   â”‚                                                                      â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚   â”‚ Context Builder  â”‚  â”‚ Output Parser    â”‚  â”‚ Token Tracker    â”‚         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                           â”‚
                    â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         POSTGRESQL            â”‚  â”‚                   S3                       â”‚
â”‚                               â”‚  â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚        TABLES           â”‚  â”‚  â”‚  â”‚           BUCKET STRUCTURE          â”‚  â”‚
â”‚  â”‚                         â”‚  â”‚  â”‚  â”‚                                     â”‚  â”‚
â”‚  â”‚  skills                 â”‚  â”‚  â”‚  â”‚  skills/                            â”‚  â”‚
â”‚  â”‚  â”œâ”€ id, name, type      â”‚  â”‚  â”‚  â”‚  â”œâ”€ copywriting/SKILL.md           â”‚  â”‚
â”‚  â”‚  â””â”€ s3_key, triggers    â”‚  â”‚  â”‚  â”‚  â”œâ”€ copywriting/RULES.md           â”‚  â”‚
â”‚  â”‚                         â”‚  â”‚  â”‚  â”‚  â””â”€ idea-to-spec/...               â”‚  â”‚
â”‚  â”‚  clients                â”‚  â”‚  â”‚  â”‚                                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ id, name            â”‚  â”‚  â”‚  â”‚  clients/                           â”‚  â”‚
â”‚  â”‚  â””â”€ s3_prefix           â”‚  â”‚  â”‚  â”‚  â”œâ”€ yaz-automate/profile.md        â”‚  â”‚
â”‚  â”‚                         â”‚  â”‚  â”‚  â”‚  â””â”€ yaz-automate/brand/...         â”‚  â”‚
â”‚  â”‚  users                  â”‚  â”‚  â”‚  â”‚                                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ id, api_key         â”‚  â”‚  â”‚  â”‚  outputs/                           â”‚  â”‚
â”‚  â”‚  â””â”€ created_at          â”‚  â”‚  â”‚  â”‚  â”œâ”€ copywriting/...                 â”‚  â”‚
â”‚  â”‚                         â”‚  â”‚  â”‚  â”‚  â””â”€ email-sequence/...              â”‚  â”‚
â”‚  â”‚  user_channels          â”‚  â”‚  â”‚  â”‚                                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ user_id             â”‚  â”‚  â”‚  â”‚  feedback/                          â”‚  â”‚
â”‚  â”‚  â”œâ”€ channel (telegram)  â”‚  â”‚  â”‚  â”‚  â””â”€ copywriting/2026-01-23_...     â”‚  â”‚
â”‚  â”‚  â””â”€ channel_user_id     â”‚  â”‚  â”‚  â”‚                                     â”‚  â”‚
â”‚  â”‚                         â”‚  â”‚  â”‚  â”‚  workflows/                         â”‚  â”‚
â”‚  â”‚  runs                   â”‚  â”‚  â”‚  â”‚  â””â”€ email-campaign.md               â”‚  â”‚
â”‚  â”‚  â”œâ”€ id, skill_id        â”‚  â”‚  â”‚  â”‚                                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ status, tokens      â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚  â””â”€ inngest_event_id    â”‚  â”‚  â”‚                                           â”‚
â”‚  â”‚                         â”‚  â”‚  â”‚                                           â”‚
â”‚  â”‚  outputs                â”‚  â”‚  â”‚                                           â”‚
â”‚  â”‚  â”œâ”€ id, run_id          â”‚  â”‚  â”‚                                           â”‚
â”‚  â”‚  â””â”€ s3_key, format      â”‚  â”‚  â”‚                                           â”‚
â”‚  â”‚                         â”‚  â”‚  â”‚                                           â”‚
â”‚  â”‚  feedback               â”‚  â”‚  â”‚                                           â”‚
â”‚  â”‚  â”œâ”€ output_id, scores   â”‚  â”‚  â”‚                                           â”‚
â”‚  â”‚  â””â”€ issues, suggestions â”‚  â”‚  â”‚                                           â”‚
â”‚  â”‚                         â”‚  â”‚  â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚                                           â”‚
â”‚                               â”‚  â”‚                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow: Telegram Message â†’ Output

```
1. USER SENDS MESSAGE
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Telegram User: "Write homepage copy for Yaz Automate"
                              â”‚
                              â–¼
2. TELEGRAM WEBHOOK RECEIVES UPDATE
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   POST /api/v1/webhooks/telegram
   {
     "message": {
       "from": { "id": 123456789 },
       "text": "Write homepage copy for Yaz Automate"
     }
   }
                              â”‚
                              â–¼
3. USER AUTHENTICATION
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   SELECT * FROM user_channels
   WHERE channel = 'telegram' AND channel_user_id = '123456789'
   â†’ Returns user_id (or error if not linked)
                              â”‚
                              â–¼
4. SKILL DETECTION
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   POST /api/v1/skills/detect
   {
     "message": "Write homepage copy for Yaz Automate",
     "client_id": "yaz-automate"  // extracted from message
   }

   Detection flow:
   a. No direct command found (/copywriting)
   b. Keyword match: "homepage copy" â†’ copywriting (confidence: 0.92)
   c. High confidence â†’ skip Claude disambiguation

   Response:
   {
     "skill": "copywriting",
     "confidence": 0.92,
     "extracted": { "client_id": "yaz-automate" }
   }
                              â”‚
                              â–¼
5. CREATE RUN & QUEUE JOB
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   POST /api/v1/runs
   {
     "skill_id": "copywriting",
     "client_id": "yaz-automate",
     "user_message": "Write homepage copy for Yaz Automate",
     "user_id": "user-uuid"
   }

   â†’ INSERT INTO runs (status: 'queued')
   â†’ Inngest: send('skill.execute', { run_id, skill_id, client_id, message })

   Response:
   {
     "run_id": "run-uuid",
     "status": "queued"
   }
                              â”‚
                              â–¼
6. TELEGRAM: SEND "WORKING" MESSAGE
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Bot sends: "Working on your homepage copy... This may take 1-2 minutes."
   (Stores message_id for later editing)
                              â”‚
                              â–¼
7. INNGEST: EXECUTE SKILL
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Function: skill.execute

   a. Load skill from S3:
      GET s3://skills/copywriting/SKILL.md
      GET s3://skills/copywriting/RULES.md (if exists)

   b. Load client context from S3:
      GET s3://clients/yaz-automate/profile.md
      GET s3://clients/yaz-automate/brand/voice.md
      GET s3://clients/yaz-automate/brand/messaging.md
      GET s3://clients/yaz-automate/audience/primary-icp.md
      GET s3://clients/yaz-automate/product/overview.md

   c. Build prompt:
      [SKILL.md content]
      [RULES.md content]
      ---
      Client Context:
      [profile.md]
      [voice.md]
      [messaging.md]
      [primary-icp.md]
      [product/overview.md]
      ---
      User Request:
      "Write homepage copy for Yaz Automate"

   d. Execute via Agent SDK:
      const result = await query({
        prompt: combinedPrompt,
        model: 'claude-sonnet-4',
        tools: ['WebSearch', 'WebFetch'],
      });

   e. Parse output and save to S3:
      PUT s3://outputs/copywriting/yaz-automate-homepage-2026-01-25.md

   f. Update database:
      UPDATE runs SET status = 'completed', tokens_used = 12500
      INSERT INTO outputs (run_id, s3_key, format)
                              â”‚
                              â–¼
8. INNGEST: CALLBACK TO API
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   POST /api/v1/webhooks/inngest
   {
     "event": "skill.execute.completed",
     "run_id": "run-uuid",
     "output_id": "output-uuid",
     "s3_key": "outputs/copywriting/yaz-automate-homepage-2026-01-25.md"
   }
                              â”‚
                              â–¼
9. TELEGRAM: EDIT MESSAGE WITH RESULT
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Bot edits original message:
   "âœ“ Homepage copy for Yaz Automate is ready!

   [Preview of first 500 chars...]

   ğŸ“¥ Download: /download output-uuid
   â­ Rate this output: [1] [2] [3] [4] [5]"
                              â”‚
                              â–¼
10. USER PROVIDES FEEDBACK (OPTIONAL)
    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    User taps [4]

    POST /api/v1/feedback
    {
      "output_id": "output-uuid",
      "accuracy_score": 4,
      "quality_score": 4,
      "usefulness_score": 4,
      "overall_score": 4,
      "source": "telegram"
    }

    Bot: "Thanks for the feedback! What worked well? (Reply or tap Skip)"
```

## Database Relationships

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ENTITY RELATIONSHIP DIAGRAM                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚    users      â”‚
                                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ id            â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚           â”‚ email         â”‚              â”‚
                        â”‚           â”‚ api_key       â”‚              â”‚
                        â”‚           â”‚ created_at    â”‚              â”‚
                        â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
                        â”‚                   â”‚                      â”‚
                        â”‚                   â”‚ 1:N                  â”‚
                        â”‚                   â–¼                      â”‚
                        â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
                        â”‚           â”‚ user_channels â”‚              â”‚
                        â”‚           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
                        â”‚           â”‚ id            â”‚              â”‚
                        â”‚           â”‚ user_id (FK)  â”‚              â”‚
                        â”‚           â”‚ channel       â”‚              â”‚
                        â”‚           â”‚ channel_id    â”‚              â”‚
                        â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
                        â”‚                                          â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                       â”‚              â”‚                         â”‚
            â”‚ N:1                   â”‚              â”‚ N:1                     â”‚
            â–¼                       â”‚              â–¼                         â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
    â”‚    skills     â”‚               â”‚      â”‚   clients     â”‚                 â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤               â”‚      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                 â”‚
    â”‚ id            â”‚â—„â”€â”€â”€â”€â”€â”€â”       â”‚      â”‚ id            â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
    â”‚ name          â”‚       â”‚       â”‚      â”‚ name          â”‚          â”‚      â”‚
    â”‚ type          â”‚       â”‚       â”‚      â”‚ user_id (FK)  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”˜
    â”‚ s3_key        â”‚       â”‚       â”‚      â”‚ s3_prefix     â”‚          â”‚
    â”‚ triggers      â”‚       â”‚       â”‚      â”‚ created_at    â”‚          â”‚
    â”‚ has_rules     â”‚       â”‚       â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
    â”‚ has_subdirs   â”‚       â”‚       â”‚              â”‚                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚       â”‚              â”‚                  â”‚
                            â”‚       â”‚              â”‚                  â”‚
                            â”‚       â”‚              â”‚                  â”‚
                            â”‚       â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
                            â”‚       â”‚   â”‚                   â”‚         â”‚
                            â”‚       â”‚   â”‚ N:1               â”‚ N:1     â”‚
                            â”‚       â”‚   â–¼                   â–¼         â”‚
                            â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                            â”‚       â”‚  â”‚           runs             â”‚ â”‚
                            â”‚       â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
                            â”‚       â””â”€â–ºâ”‚ id                         â”‚ â”‚
                            â”‚          â”‚ user_id (FK)               â”‚â”€â”˜
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ skill_id (FK)              â”‚
                                       â”‚ client_id (FK)             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”
                                       â”‚ status                     â”‚         â”‚
                                       â”‚ user_message               â”‚         â”‚
                                       â”‚ inngest_event_id           â”‚         â”‚
                                       â”‚ tokens_used                â”‚         â”‚
                                       â”‚ started_at                 â”‚         â”‚
                                       â”‚ completed_at               â”‚         â”‚
                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
                                                       â”‚                      â”‚
                                                       â”‚ 1:N                  â”‚
                                                       â–¼                      â”‚
                                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
                                       â”‚          outputs           â”‚         â”‚
                                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚
                                       â”‚ id                         â”‚â—„â”€â”€â”€â”    â”‚
                                       â”‚ run_id (FK)                â”‚â”€â”€â”€â”€â”˜    â”‚
                                       â”‚ s3_key                     â”‚         â”‚
                                       â”‚ format                     â”‚         â”‚
                                       â”‚ created_at                 â”‚         â”‚
                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
                                                       â”‚                      â”‚
                                                       â”‚ 1:1                  â”‚
                                                       â–¼                      â”‚
                                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
                                       â”‚         feedback           â”‚         â”‚
                                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚
                                       â”‚ id                         â”‚         â”‚
                                       â”‚ output_id (FK)             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚ accuracy_score             â”‚
                                       â”‚ quality_score              â”‚
                                       â”‚ usefulness_score           â”‚
                                       â”‚ rule_compliance_score      â”‚
                                       â”‚ overall_score              â”‚
                                       â”‚ what_worked_well           â”‚
                                       â”‚ issues_json                â”‚
                                       â”‚ suggested_rule_changes     â”‚
                                       â”‚ source                     â”‚
                                       â”‚ created_at                 â”‚
                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## S3 Bucket Organization

```
marketing-agent-bucket/
â”‚
â”œâ”€â”€ skills/                              # Uploaded from .claude/skills/
â”‚   â”œâ”€â”€ copywriting/
â”‚   â”‚   â”œâ”€â”€ SKILL.md                     # Main skill definition
â”‚   â”‚   â””â”€â”€ RULES.md                     # Additional rules (if exists)
â”‚   â”œâ”€â”€ email-sequence/
â”‚   â”‚   â”œâ”€â”€ SKILL.md
â”‚   â”‚   â””â”€â”€ RULES.md
â”‚   â”œâ”€â”€ page-cro/
â”‚   â”‚   â”œâ”€â”€ SKILL.md
â”‚   â”‚   â””â”€â”€ RULES.md
â”‚   â”œâ”€â”€ idea-to-spec/                    # Complex skill with subdirs
â”‚   â”‚   â”œâ”€â”€ SKILL.md
â”‚   â”‚   â”œâ”€â”€ document-templates/
â”‚   â”‚   â”‚   â””â”€â”€ *.md
â”‚   â”‚   â”œâ”€â”€ expert-modes/
â”‚   â”‚   â”‚   â””â”€â”€ *.md
â”‚   â”‚   â””â”€â”€ research-prompts/
â”‚   â”‚       â””â”€â”€ *.md
â”‚   â””â”€â”€ [33 other skills]/
â”‚       â””â”€â”€ SKILL.md
â”‚
â”œâ”€â”€ clients/                             # Uploaded from clients/
â”‚   â”œâ”€â”€ yaz-automate/
â”‚   â”‚   â”œâ”€â”€ profile.md
â”‚   â”‚   â”œâ”€â”€ brand/
â”‚   â”‚   â”‚   â”œâ”€â”€ voice.md
â”‚   â”‚   â”‚   â”œâ”€â”€ messaging.md
â”‚   â”‚   â”‚   â””â”€â”€ assets.md
â”‚   â”‚   â”œâ”€â”€ audience/
â”‚   â”‚   â”‚   â”œâ”€â”€ primary-icp.md
â”‚   â”‚   â”‚   â”œâ”€â”€ secondary-icp.md
â”‚   â”‚   â”‚   â”œâ”€â”€ anti-personas.md
â”‚   â”‚   â”‚   â””â”€â”€ customer-journey.md
â”‚   â”‚   â”œâ”€â”€ product/
â”‚   â”‚   â”‚   â”œâ”€â”€ overview.md
â”‚   â”‚   â”‚   â”œâ”€â”€ pricing.md
â”‚   â”‚   â”‚   â”œâ”€â”€ differentiators.md
â”‚   â”‚   â”‚   â””â”€â”€ objections.md
â”‚   â”‚   â”œâ”€â”€ market/
â”‚   â”‚   â”‚   â”œâ”€â”€ competitors.md
â”‚   â”‚   â”‚   â”œâ”€â”€ industry.md
â”‚   â”‚   â”‚   â””â”€â”€ proof.md
â”‚   â”‚   â”œâ”€â”€ operations/
â”‚   â”‚   â”‚   â”œâ”€â”€ contacts.md
â”‚   â”‚   â”‚   â”œâ”€â”€ process.md
â”‚   â”‚   â”‚   â””â”€â”€ tools.md
â”‚   â”‚   â”œâ”€â”€ projects/
â”‚   â”‚   â”‚   â”œâ”€â”€ active.md
â”‚   â”‚   â”‚   â””â”€â”€ history.md
â”‚   â”‚   â””â”€â”€ research/
â”‚   â”‚       â””â”€â”€ notes.md
â”‚   â””â”€â”€ [other clients]/
â”‚
â”œâ”€â”€ outputs/                             # Generated content
â”‚   â”œâ”€â”€ copywriting/
â”‚   â”‚   â”œâ”€â”€ yaz-automate-homepage-2026-01-23.md
â”‚   â”‚   â””â”€â”€ yaz-automate-pricing-2026-01-24.md
â”‚   â”œâ”€â”€ email-sequence/
â”‚   â”‚   â””â”€â”€ yaz-automate-onboarding-2026-01-25.md
â”‚   â””â”€â”€ [skill-name]/
â”‚       â””â”€â”€ [client]-[type]-[date].md
â”‚
â”œâ”€â”€ feedback/                            # Feedback files
â”‚   â”œâ”€â”€ copywriting/
â”‚   â”‚   â””â”€â”€ 2026-01-23_homepage-copy.md
â”‚   â””â”€â”€ [skill-name]/
â”‚       â””â”€â”€ [date]_[descriptor].md
â”‚
â””â”€â”€ workflows/                           # Multi-skill workflows
    â”œâ”€â”€ email-campaign.md
    â”œâ”€â”€ landing-page-launch.md
    â””â”€â”€ skill-improvement.md
```

## Package Structure

The monorepo follows a clean separation of concerns:

```
marketing-agent-api/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ api/                  # Hono API server
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ routes/       # API route handlers
â”‚   â”‚   â”‚   â”œâ”€â”€ middleware/   # Auth, rate limiting, validation
â”‚   â”‚   â”‚   â””â”€â”€ index.ts      # App entry point
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚
â”‚   â””â”€â”€ telegram-bot/         # Telegram webhook handler
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ commands/     # Bot command handlers
â”‚       â”‚   â”œâ”€â”€ keyboards/    # Inline keyboard builders
â”‚       â”‚   â””â”€â”€ index.ts
â”‚       â””â”€â”€ package.json
â”‚
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ shared/               # Shared types and validators
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ types/        # TypeScript interfaces
â”‚   â”‚   â”‚   â””â”€â”€ validators/   # Zod schemas
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚
â”‚   â”œâ”€â”€ db/                   # Database package
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ schema/       # Drizzle schema definitions
â”‚   â”‚   â”‚   â”œâ”€â”€ migrations/   # Database migrations
â”‚   â”‚   â”‚   â””â”€â”€ index.ts      # Drizzle client export
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚
â”‚   â”œâ”€â”€ storage/              # S3 operations
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ client.ts     # S3 client setup
â”‚   â”‚   â”‚   â”œâ”€â”€ skills.ts     # Skill file operations
â”‚   â”‚   â”‚   â”œâ”€â”€ clients.ts    # Client file operations
â”‚   â”‚   â”‚   â””â”€â”€ outputs.ts    # Output file operations
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚
â”‚   â”œâ”€â”€ skill-detector/       # Skill detection logic
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ keywords.ts   # Keyword mapping
â”‚   â”‚   â”‚   â”œâ”€â”€ matcher.ts    # Matching algorithm
â”‚   â”‚   â”‚   â””â”€â”€ claude.ts     # Claude fallback
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚
â”‚   â”œâ”€â”€ agent-executor/       # Claude Agent SDK wrapper
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ executor.ts   # Main execution logic
â”‚   â”‚   â”‚   â”œâ”€â”€ context.ts    # Context builder
â”‚   â”‚   â”‚   â””â”€â”€ parser.ts     # Output parser
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚
â”‚   â””â”€â”€ inngest-functions/    # Background job definitions
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ skill-execute.ts
â”‚       â”‚   â”œâ”€â”€ skill-retry.ts
â”‚       â”‚   â””â”€â”€ feedback-process.ts
â”‚       â””â”€â”€ package.json
â”‚
â”œâ”€â”€ turbo.json                # Turborepo configuration
â”œâ”€â”€ pnpm-workspace.yaml       # pnpm workspace config
â””â”€â”€ package.json              # Root package.json
```

## Security Considerations

### API Key Management
- Keys stored hashed in database
- Keys never logged or exposed in errors
- Rotation support with grace period

### Rate Limiting
- Per-user request limits
- Per-skill limits for expensive operations
- IP-based limits for unauthenticated endpoints

### Input Validation
- All inputs validated via Zod schemas
- File uploads restricted by type and size
- SQL injection prevented by Drizzle ORM

### S3 Security
- Private bucket with no public access
- Signed URLs for output downloads
- Separate credentials per environment

## Performance Considerations

### Caching Strategy
- Skill content cached in memory (changes rarely)
- Client context cached per-session
- Rate limit counters in Redis (future)

### Async Processing
- All skill executions via Inngest queue
- Non-blocking webhook responses
- Configurable concurrency limits

### Database Optimization
- Indexes on frequently queried columns
- Connection pooling via Drizzle
- Query result pagination
